<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Orders — Magelan</title>

    <link href="https://fonts.googleapis.com/css2?family=Pirata+One&display=swap" rel="stylesheet">

    <link rel="stylesheet" th:href="@{/styles.css}" href="/styles.css">
    <link rel="stylesheet" th:href="@{/orders.css}" href="/orders.css">
</head>

<body class="orders-body">
<div class="orders-container">
    <div class="logo-container">
        <a th:href="${isAuthenticated} ? @{/home} : @{/}" href="/" class="menu-logo-link">
            <img src="/magelan-index.jpg" alt="Magelan Logo" class="logo-image">
        </a>
    </div>

    <section class="panel">
        <h1 class="title">My Orders</h1>
        <div th:if="${orderMessage}" class="alert success">
            <p th:text="${orderMessage}">Your order was submitted.</p>
        </div>

        <div class="table-wrapper"
             th:if="${orderItems != null and !#lists.isEmpty(orderItems)}">
            <table class="orders-table">
                <thead>
                <tr>
                    <th>Item</th>
                    <th class="col-center">Qty</th>
                    <th class="col-right">Price</th>
                    <th class="col-right">Subtotal</th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="item : ${orderItems}">
                    <td th:text="${item.product.name}">Magelan Burger</td>
                    <td class="col-center" th:text="${item.quantity}">1</td>
                    <td class="col-right" th:text="${item.unitPrice}">14.90</td>
                    <td class="col-right" th:text="${item.totalPrice}">14.90</td>
                    <td class="col-right">
                        <form th:action="@{/orders/items/{itemId}(itemId=${item.id})}" method="post" class="inline-form">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                            <input type="hidden" name="_method" value="delete"/>
                            <button type="submit" class="ghost-btn">✕</button>
                        </form>
                    </td>
                </tr>
                </tbody>
            </table>

            <div class="total-section">
                <span>Total:</span>
                <strong th:text="${#numbers.formatDecimal(totalAmount, 1, 2)}">0.00</strong>
            </div>
        </div>

        <div class="empty"
             th:if="${orderItems == null or #lists.isEmpty(orderItems)}">
            <p>Your current order is empty.</p>
        </div>

        <div class="add-section">
            <h2 class="subtitle">Add from Menu</h2>
            <form th:action="@{/orders/items}" method="post" class="add-form">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

                <div class="add-form-row">
                    <label for="product" class="label">Item</label>
                    <select id="product" name="productId" class="input" required>
                        <option value="" disabled selected>Select a dish</option>
                        <option th:each="p : ${products}"
                                th:value="${p.id}"
                                th:text="${p.name}">
                            Product Name
                        </option>
                    </select>
                </div>

                <div class="add-form-row">
                    <label for="quantity" class="label">Qty</label>
                    <input id="quantity" name="quantity" type="number"
                           min="1" value="1" class="input input-qty" required>
                </div>

                <div class="add-form-actions">
                    <button type="submit" class="btn-primary">Add to Order</button>
                    <a th:href="@{/menu}" href="/menu" class="btn-secondary">View Menu</a>
                </div>
            </form>
        </div>

        <div class="submit-section"
             th:if="${orderItems != null and !#lists.isEmpty(orderItems)}">
            <h2 class="subtitle">Delivery Details</h2>
            <form th:action="@{/orders/submit}" method="post" class="submit-form">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

                <div class="form-row">
                    <input type="text" name="fullName"
                           placeholder="Full Name" class="input" required
                           th:value="${#strings.trim((user.firstName ?: '') + ' ' + (user.lastName ?: ''))}">
                </div>

                <div class="form-row">
                    <input type="text" name="phone"
                           placeholder="Phone Number" class="input" required
                           th:value="${user.phoneNumber} ?: ''">
                </div>

                <div class="form-row">
                    <input type="text" name="address"
                           placeholder="Delivery Address" class="input" required
                           th:value="${user.address} ?: ''">
                </div>

                <div class="form-row">
                    <textarea name="notes"
                              placeholder="Additional Notes (optional)"
                              class="textarea"></textarea>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary">Submit Order</button>
                    <a th:href="@{/home}" href="/home" class="btn-secondary">Back to Home</a>
                </div>
            </form>
        </div>

        <div class="history-section"
             th:if="${pastOrders != null and !#lists.isEmpty(pastOrders)}">
            <h2 class="subtitle">Previous Orders</h2>

            <div class="table-wrapper">
                <table class="orders-table history-table">
                    <thead>
                    <tr>
                        <th>Date</th>
                        <th>Status</th>
                        <th class="col-right">Total</th>
                        <th class="col-right">Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="o : ${pastOrders}">
                        <td th:text="${#temporals != null ? #temporals.format(o.createdOn, 'dd.MM.yyyy HH:mm') : o.createdOn}">
                            01.01.2025 19:30
                        </td>
                        <td th:text="${o.orderStatus}">SUBMITTED</td>
                        <td class="col-right"
                            th:text="${#numbers.formatDecimal(o.amount, 1, 2)}">
                            0.00
                        </td>
                        <td class="col-right">
                            <a th:href="@{|/orders/${o.id}|}" class="btn-secondary btn-small">View</a>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </section>
</div>
</body>
</html>
